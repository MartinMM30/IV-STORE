<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestionar Cuenta - IV Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #0a0a0a;
        color: #ededed;
      }
      .form-container {
        background-color: rgba(10, 10, 10, 0.6);
        border: 1px solid #262626;
        backdrop-filter: blur(10px);
      }
      .form-input {
        background-color: transparent;
        border: 1px solid #404040;
      }
      .form-input:focus {
        border-color: #5c3aff;
        outline: none;
      }
      .btn-accent {
        background-color: #5c3aff;
      }
      .btn-accent:hover {
        opacity: 0.8;
      }
      .btn-disabled {
        background-color: #404040;
        cursor: not-allowed;
      }
      .message {
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 1.25rem;
        text-align: center;
        font-size: 0.875rem;
      }
      .message-success {
        background-color: rgba(74, 222, 128, 0.1);
        border: 1px solid #22c55e;
        color: #86efac;
      }
      .message-error {
        background-color: rgba(248, 113, 113, 0.1);
        border: 1px solid #ef4444;
        color: #fca5a5;
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center px-4">
    <div
      id="app-container"
      class="w-full max-w-md form-container rounded-2xl shadow-xl p-8"
    >
      <!-- El contenido se generar치 con JavaScript -->
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getAuth,
        verifyPasswordResetCode,
        confirmPasswordReset,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

      // --- 游뚿 CAMBIO CLAVE: Pega aqu칤 tu objeto firebaseConfig completo ---
      const firebaseConfig = {
        apiKey: "AIzaSyAmg8oKTfIT56_F7yELRZAoyZMq-MqRl6E",
        authDomain: "iv-design-c13bc.firebaseapp.com",
        projectId: "iv-design-c13bc",
        storageBucket: "iv-design-c13bc.appspot.com",
        messagingSenderId: "654972044837",
        appId: "1:654972044837:web:fe6725365c57374cd8e1cc",
        measurementId: "G-1HXR7VR9LV",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // ... (El resto del c칩digo JavaScript no necesita cambios) ...
      const container = document.getElementById("app-container");

      function getParameterByName(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      function render(html) {
        container.innerHTML = html;
      }

      async function handleAuthAction() {
        const mode = getParameterByName("mode");
        const oobCode = getParameterByName("oobCode");

        if (mode === "resetPassword" && oobCode) {
          await handleResetPassword(oobCode);
        } else {
          renderError("Enlace inv치lido o acci칩n no soportada.");
        }
      }

      async function handleResetPassword(oobCode) {
        try {
          const email = await verifyPasswordResetCode(auth, oobCode);
          renderPasswordResetForm(oobCode, email);
        } catch (error) {
          console.error("Error de verificaci칩n:", error);
          renderError(
            "El enlace es inv치lido o ha expirado. Por favor, solicita uno nuevo."
          );
        }
      }

      function renderLoading(message = "Verificando...") {
        render(`<p class="text-center text-neutral-400">${message}</p>`);
      }

      function renderError(message) {
        render(`
                <h2 class="text-2xl font-light uppercase tracking-[0.25em] text-center mb-6">Error</h2>
                <div class="message message-error">${message}</div>
                <a href="https://iv-store.vercel.app/login" class="block text-center text-sm text-accent hover:opacity-80 mt-6">Volver a la tienda</a>
            `);
      }

      function renderPasswordResetForm(oobCode, email) {
        render(`
                <h2 class="text-2xl font-light uppercase tracking-[0.25em] text-center mb-8">Nueva Contrase침a</h2>
                <div id="message-area"></div>
                <p class="text-center text-xs text-neutral-400 mb-6">Est치s cambiando la contrase침a para: <br /><span class="font-bold text-neutral-200">${email}</span></p>
                <form id="reset-form" class="space-y-5">
                    <input type="password" id="new-password" placeholder="Nueva Contrase침a" required class="w-full form-input text-sm px-4 py-3 rounded-md transition">
                    <input type="password" id="confirm-password" placeholder="Confirmar Nueva Contrase침a" required class="w-full form-input text-sm px-4 py-3 rounded-md transition">
                    <button type="submit" id="submit-btn" class="w-full py-3 text-sm uppercase tracking-widest rounded-md transition btn-accent">Cambiar Contrase침a</button>
                </form>
            `);

        document
          .getElementById("reset-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById("new-password").value;
            const confirmPassword =
              document.getElementById("confirm-password").value;
            const messageArea = document.getElementById("message-area");
            const submitBtn = document.getElementById("submit-btn");

            messageArea.innerHTML = "";
            if (newPassword !== confirmPassword) {
              messageArea.innerHTML =
                '<div class="message message-error">Las contrase침as no coinciden.</div>';
              return;
            }
            if (newPassword.length < 6) {
              messageArea.innerHTML =
                '<div class="message message-error">La contrase침a debe tener al menos 6 caracteres.</div>';
              return;
            }

            submitBtn.textContent = "Cambiando...";
            submitBtn.disabled = true;
            submitBtn.classList.add("btn-disabled");

            try {
              await confirmPasswordReset(auth, oobCode, newPassword);
              render(`
                        <h2 class="text-2xl font-light uppercase tracking-[0.25em] text-center mb-6">칄xito</h2>
                        <div class="message message-success">춰Tu contrase침a ha sido cambiada! Ser치s redirigido a la p치gina de inicio de sesi칩n en 3 segundos.</div>
                    `);
              setTimeout(
                () =>
                  window.location.assign("https://iv-store.vercel.app/login"),
                3000
              );
            } catch (error) {
              console.error("Error al confirmar:", error);
              messageArea.innerHTML =
                '<div class="message message-error">Ocurri칩 un error. El enlace puede haber expirado.</div>';
              submitBtn.textContent = "Cambiar Contrase침a";
              submitBtn.disabled = false;
              submitBtn.classList.remove("btn-disabled");
            }
          });
      }

      document.addEventListener("DOMContentLoaded", () => {
        renderLoading();
        handleAuthAction();
      });
    </script>
  </body>
</html>
